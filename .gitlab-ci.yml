stages:
  - maker
  - build
  - test

build-maker:
  stage: maker
  when: manual
  image: docker:19.03
  services: ['docker:dind']
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull alpine:3.16
    - docker run -it --detach --name maker docker
    - docker exec maker apk add make py3-pip
    - docker commit maker $CI_REGISTRY_IMAGE:maker
    - docker push $CI_REGISTRY_IMAGE:maker

build-tester:
  stage: maker
  when: manual
  image: docker:19.03
  services: ['docker:dind']
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull alpine:3.16
    - docker run -it --detach --name tester python:3.11-alpine
    - docker exec tester apk add make
    - docker exec tester pip install coverage
    - docker commit tester $CI_REGISTRY_IMAGE:tester
    - docker push $CI_REGISTRY_IMAGE:tester

build-docker:
  stage: build
  image: $CI_REGISTRY_IMAGE:maker
  services: ['docker:dind']
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $CI_REGISTRY_IMAGE:test || true
    - docker build --file Dockerfile.dev --cache-from $CI_REGISTRY_IMAGE:test --tag $CI_REGISTRY_IMAGE:test .
    - docker push $CI_REGISTRY_IMAGE:test
  rules:
    - changes:
        - .gitlab-ci.yml
        - tests/Dockerfile.dev
        - tests/.dockerignore
        - setup.py

build-dist:
  stage: build
  image: python:3.11-alpine
  script:
    - python setup.py sdist
  artifacts:
    paths:
      - dist

test:
  stage: test
  image: $CI_REGISTRY_IMAGE:tester
  before_script:
    - pip install dist/*.tar.gz
    - ls -A | grep -v -E 'Makefile|tests' | xargs -r -I% rm -rf %
  script:
    - python -m coverage run --source=sobiraka -m unittest discover --start-directory=. --verbose
    - python -m coverage report --precision=1 --skip-empty --show-missing --fail-under=100
  coverage: '/TOTAL .+ (\d+\.\d+)%/'