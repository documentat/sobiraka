# Мультиязычность

Один проект в Собираке может включать в себя несколько вариантов документации на разных языках. Данная статья описывает практики, рекомендуемые для ведения такого проекта.


## Организация файлов {#file-structure}

Для создания мультиязычного проекта создайте отдельные директории для каждого языка, например, `src/en` и `src/ru`. В [манифесте проекта](../5-data-types/1-manifest.md) укажите каждую такую директорию как корень отдельного [тома](1-volumes.md).

В поле `primary` укажите, какой вариант документации считается основным. Понятие основного тома важно для [версионирования текста](#versioning). Если поле `primary` опущено, основным считается самый первый том, описанный в манифесте.

Пример манифеста мультиязычного проекта:

```yaml
primary: ru
languages:
  en:
    title: Documentation
    paths:
      root: src/en
      include: ['**/*.md']
  ru:
    title: Документация
    paths:
      root: src/ru
      include: ['**/*.md']
```

::: warning
В текущей реализации в поле `primary` следует указывать не название языка, а идентификатор тома (см. [Проекты и тома](1-volumes.md)). Так, в проекте с двухуровневой структурой манифеста вам может потребоваться написать `primary: ru/admin-manual` вместо `primary: ru`. Это поведение изменится в будущем, см. [issue #23](https://git.itoolabs.com/documentation/builder/-/issues/23).
:::


## Переключение языка в HTML {#switching-languages}

При разработке HTML-темы для Собираки рекомендуется позволить пользователю быстро переходить к версиям текущей страницы на других языках. Ниже приведён пример реализации такого переключения.

```html
{%- raw %}
{% set translations = project.get_all_translations(page) %}
{% if translations | length > 1 %}
  <ul class='translations'>
    {% for translation in translations %}
      {% if translation is sameas page %}
        {% set name = Language.from_part1(translation.volume.lang).name %}
        <li>{{ name }}</li>
      {% else %}
        {% set url = builder.make_internal_url(translation, page=page) %}
        {% set name = Language.from_part1(translation.volume.lang).name %}
        <li><a href='{{ url }}'>{{ name }}</a></li>
      {% endif %}
    {% endfor %}
  </ul>
{% endif %}
{% endraw -%}
```

В примере используется метод `project.get_all_translations()`. Он перебирает все тома с таким же кодовым именем, как у текущего тома, и в каждом из них находит страницу с таким же путём, как у текущей страницы. Сама текущая страница так же попадает в возвращаемый список. В примере проверяется, что в списке более одного элемента, то есть в нём существуют страницы, кроме текущей.

Чтобы отличить текущую страницу от остальных, используется стандартная проверка [`sameas`](https://jinja.palletsprojects.com/en/3.1.x/templates/#jinja-tests.sameas) в Jinja. Название языка текущей страницы отображается простым текстом без ссылки. Названия остальных страниц отображаются как ссылки на эти страницы.

Полные названия языков формируются с помощью библиотеки [`iso639`](https://github.com/jacksonllee/iso639). Например, для кода “ru” сформируется название “Russian”.

Ссылки на страницы формируются с помощью метода `make_internal_url()` класса `HtmlBuilder`, который является частью Собираки.


## Версионирование текста {#versioning}

При работе над мультиязычным проектом важно следить за актуальностью всех переводов каждого текста. Собирака не может самостоятельно определить актуальность текста или актуализировать его, но в её состав входит скрипт, который помогает отслеживать свою работу автору документации.

Работа скрипта предполагает, что:

- один из языков проекта считается основным (см. поле [`primary`](../5-data-types/1-manifest.md#primary) манифеста),
- в исходных файлах страниц указываются версии текста (см. поле [`version`](../5-data-types/2-metadata.md#version) метаданных).

При внесении критичных изменений в оригинал обязательно увеличивайте его мажорную версию. Например, если вы добавили описание новой функциональности в оригинал, ранее имевший версию 2.4, замените её на 3.0. Благодаря этому Собирака будет знать, что переводы, написанные на основе версии оригинала 2.4, могли устареть.

При написании или актуализации перевода указывайте в нём ту версию оригинала, с которой вы работали. Например, если вы обновили перевод до соответствия оригиналу с версией 3.0 (или прочитали его и убедились, что такое обновление не требуется), укажите для перевода версию 3.0.

При внесении в оригинал или перевод косметических правок, таких как исправление грамматических ошибок, увеличивайте минорную версию, не меняя мажорную. Например, если вы убрали лишнюю запятую в оригинале или переводе, имевшем версию 3.0, замените её на 3.1.

Скрипт [`check_translations`](../4-cli/check_translations.md) сравнивает версии переводов и оригиналов и делит страницы на три категории:

- _Up-to-date_ — версия перевода совпадает с версией оригинала полностью,
- _Modified_ — версия перевода совпадает с версией оригинала с точностью до мажорной составляющей,
- _Outdated_ — версия перевода значительно отличается от версии оригинала.

Пример вывода скрипта:

```
en:
  This is the primary volume
  Pages: 3
ru:
  Up-to-date pages: 1
  Modified pages: 1
    src-ru/aaa.md
  Outdated pages: 1
    src-ru/bbb.md
```


## Просмотр списка изменений {#changelog}

Как правило, проекты, использующие подход “docs as code”, ведутся в системе контроля версий Git. Для таких проектов предназначен вспомогательный скрипт [`changelog`](../4-cli/changelog.md). Он сравнивает два любых коммита в репозитории и анализирует, как изменились версии страниц между ними.

Скрипт корректно обрабатывает случаи, когда корень тома был перемещён между версиями, если при этом не изменился идентификатор тома (см. [Проекты и тома](1-volumes.md)). Обратите внимание, что в выводе при этом используются пути к файлам из второго коммита.

Пример вывода скрипта:

```
Version upgraded:
  en/version-upgraded.md (1.0 -> 2.4)
Text upgraded:
  en/text-upgraded.md (1.0)
Both upgraded:
  en/both-upgraded.md (1.0 -> 2.4)
Version downgraded:
  en/version-downgraded.md (2.4 -> 1.0)
Both downgraded:
  en/both-downgraded.md (2.4 -> 1.0)
Version appeared:
  en/version-appeared.md (1.0)
Version disappeared:
  en/version-disappeared.md (1.0)
```

